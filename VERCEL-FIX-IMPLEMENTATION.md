# Vercel éƒ¨ç½²å¤±è´¥ä¿®å¤å®æ–½æŠ¥å‘Š

**æ—¥æœŸ**: 2024-12-12  
**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆ  
**éªŒè¯**: âœ… æœ¬åœ°æµ‹è¯•é€šè¿‡

---

## æ‰§è¡Œæ‘˜è¦

æˆåŠŸä¿®å¤äº†å¯¼è‡´ Vercel éƒ¨ç½²å¤±è´¥çš„ä¸¤ä¸ªè‡´å‘½é”™è¯¯ï¼Œå¹¶å®Œæˆäº†æœ¬åœ°éªŒè¯ã€‚æ‰€æœ‰ä¿®å¤å‡é‡‡ç”¨æœ€å°æ”¹åŠ¨æ–¹æ¡ˆï¼Œç¡®ä¿ç¨³å®šæ€§å’Œå‘åå…¼å®¹æ€§ã€‚

---

## ä¿®å¤å†…å®¹

### ä¿®å¤ #1: api/auth.py ç¯å¢ƒå˜é‡å®‰å…¨å¤„ç†

**é—®é¢˜**: `TTS_API_KEY` æœªè®¾ç½®æ—¶å¯¼è‡´ `AttributeError`

**ä¿®å¤å‰**:
```python
VALID_API_KEYS = set(os.getenv("TTS_API_KEY").split(","))
```

**ä¿®å¤å**:
```python
VALID_API_KEYS = set(os.getenv("TTS_API_KEY", "sk-nanoai-default-key").split(","))
```

**å½±å“**:
- âœ… ç¯å¢ƒå˜é‡æœªè®¾ç½®æ—¶ä¸å†å´©æºƒ
- âœ… æä¾›å®‰å…¨çš„é»˜è®¤å€¼
- âœ… ä¿æŒå¤šå¯†é’¥æ”¯æŒï¼ˆé€—å·åˆ†éš”ï¼‰
- âœ… å‘åå…¼å®¹ç°æœ‰é…ç½®

---

### ä¿®å¤ #2: api/index.py åˆå§‹åŒ–é¡ºåºè°ƒæ•´

**é—®é¢˜**: `init_limiter(app)` åœ¨è·¯ç”±å®šä¹‰å‰è°ƒç”¨ï¼Œå¯¼è‡´ `KeyError`

**ä¿®å¤å‰**:
```python
# ç¬¬49-51è¡Œ
app = Flask(__name__)
CORS(app)
limiter = init_limiter(app)  # âŒ æ­¤æ—¶ view_functions ä¸ºç©º

# ... 700å¤šè¡Œå ...
@app.route('/v1/audio/speech', methods=['POST'])
def create_speech():
    ...
```

**ä¿®å¤å**:
```python
# ç¬¬49-50è¡Œ
app = Flask(__name__)
CORS(app)

# ... æ‰€æœ‰è·¯ç”±å®šä¹‰ ...

# ç¬¬854-855è¡Œï¼ˆæ‰€æœ‰è·¯ç”±å®šä¹‰ä¹‹åï¼‰
# åˆå§‹åŒ–é™æµå™¨ï¼ˆå¿…é¡»åœ¨æ‰€æœ‰è·¯ç”±å®šä¹‰ä¹‹åï¼‰
limiter = init_limiter(app)
```

**å½±å“**:
- âœ… é™æµå™¨å¯ä»¥æ­£ç¡®è®¿é—®æ‰€æœ‰è§†å›¾å‡½æ•°
- âœ… ä¿æŒç°æœ‰çš„é™æµé…ç½®
- âœ… ä¸æ”¹å˜ `api/rate_limit.py` çš„å®ç°
- âœ… æœ€å°æ”¹åŠ¨ï¼Œé£é™©æœ€ä½

---

### ä¿®å¤ #3: app.py åŒæ­¥ä¿®å¤

ä¸ºä¿æŒä¸€è‡´æ€§ï¼Œå¯¹ `app.py`ï¼ˆæœ¬åœ°å¼€å‘ç‰ˆæœ¬ï¼‰åº”ç”¨äº†ç›¸åŒçš„ä¿®å¤ï¼š

1. ç§»é™¤ç¬¬49è¡Œçš„ `limiter = init_limiter(app)` 
2. åœ¨ç¬¬983-984è¡Œï¼ˆæ‰€æœ‰è·¯ç”±å®šä¹‰ä¹‹åï¼‰æ·»åŠ é™æµå™¨åˆå§‹åŒ–

**å½±å“**:
- âœ… æœ¬åœ°å¼€å‘å’Œ Vercel éƒ¨ç½²ä»£ç ä¸€è‡´
- âœ… é¿å…æœ¬åœ°å¼€å‘ç¯å¢ƒå‡ºç°åŒæ ·é—®é¢˜

---

### æ”¹è¿› #4: ç¯å¢ƒå˜é‡æ–‡æ¡£æ›´æ–°

**æ–‡ä»¶**: `.env.example`

**æ”¹è¿›å†…å®¹**:
- æ·»åŠ æ¸…æ™°çš„åˆ†ç»„å’Œæ³¨é‡Š
- æ ‡æ³¨å¿…éœ€ vs å¯é€‰ç¯å¢ƒå˜é‡
- æä¾›å¤šå¯†é’¥é…ç½®ç¤ºä¾‹
- è¯´æ˜æ¯ä¸ªå˜é‡çš„ç”¨é€”

**ç¤ºä¾‹**:
```bash
# ==============================================================================
# REQUIRED: API Authentication
# ==============================================================================
# API key(s) for authentication
# For multiple keys, separate with commas (NO spaces)
# Example: TTS_API_KEY=sk-key1,sk-key2,sk-key3
TTS_API_KEY=sk-nanoai-your-secret-key
```

---

### æ–°å¢ #5: Vercel ç¯å¢ƒå˜é‡é…ç½®æŒ‡å—

**æ–‡ä»¶**: `VERCEL-ENVIRONMENT-SETUP.md`ï¼ˆæ–°å»ºï¼‰

**å†…å®¹**:
- å®Œæ•´çš„ Vercel ç¯å¢ƒå˜é‡é…ç½®æ­¥éª¤
- å¿…éœ€ vs å¯é€‰å˜é‡è¯´æ˜
- é…ç½®ç¤ºä¾‹ï¼ˆæœ€å°/æ¨è/å¼€å‘ï¼‰
- éªŒè¯æ–¹æ³•å’Œæµ‹è¯•å‘½ä»¤
- å¸¸è§é—®é¢˜ FAQ
- å®‰å…¨æœ€ä½³å®è·µ

---

## éªŒè¯ç»“æœ

### æœ¬åœ°æµ‹è¯• #1: æ— ç¯å¢ƒå˜é‡å¯¼å…¥æµ‹è¯•

```bash
$ unset TTS_API_KEY
$ python3 -c "from api.index import app; print('âœ“ Import successful')"
```

**ç»“æœ**: âœ… æˆåŠŸï¼ˆä½¿ç”¨é»˜è®¤å¯†é’¥ï¼‰

---

### æœ¬åœ°æµ‹è¯• #2: å•å¯†é’¥é…ç½®æµ‹è¯•

```bash
$ export TTS_API_KEY="sk-test-key"
$ python3 -c "from api.index import app; from api.auth import VALID_API_KEYS; \
  print(f'Keys: {VALID_API_KEYS}')"
```

**ç»“æœ**: âœ… æˆåŠŸ  
**è¾“å‡º**: `Keys: {'sk-test-key'}`

---

### æœ¬åœ°æµ‹è¯• #3: å¤šå¯†é’¥é…ç½®æµ‹è¯•

```bash
$ export TTS_API_KEY="sk-key1,sk-key2,sk-key3"
$ python3 -c "from api.auth import VALID_API_KEYS; print(f'Keys: {VALID_API_KEYS}')"
```

**ç»“æœ**: âœ… æˆåŠŸ  
**è¾“å‡º**: `Keys: {'sk-key3', 'sk-key1', 'sk-key2'}`

---

### æœ¬åœ°æµ‹è¯• #4: Flask åº”ç”¨å¥åº·æ£€æŸ¥

```bash
$ export TTS_API_KEY="sk-test"
$ python3 -c "from api.index import app; \
  client = app.test_client(); \
  response = client.get('/health'); \
  print(f'Status: {response.status_code}'); \
  print(f'Response: {response.get_json()}')"
```

**ç»“æœ**: âœ… æˆåŠŸï¼ˆHTTP 200ï¼‰  
**è¾“å‡º**:
```json
{
  "status": "ok",
  "version": "1.0.0",
  "models_in_cache": 1,
  "timestamp": 1765550745,
  "checks": {
    "tts_engine": "healthy",
    "cache": "healthy (1 models)",
    "memory": "45% used"
  }
}
```

---

### æœ¬åœ°æµ‹è¯• #5: è®¤è¯åŠŸèƒ½æµ‹è¯•

```bash
$ export TTS_API_KEY="sk-test"
$ python3 << 'EOF'
from api.index import app
client = app.test_client()

# æ— è®¤è¯
response = client.get('/v1/models')
print(f'Without auth: {response.status_code} (expected 401)')

# æ­£ç¡®è®¤è¯
response = client.get('/v1/models', headers={'Authorization': 'Bearer sk-test'})
print(f'With correct auth: {response.status_code} (expected 200)')

# é”™è¯¯è®¤è¯
response = client.get('/v1/models', headers={'Authorization': 'Bearer wrong'})
print(f'With wrong auth: {response.status_code} (expected 401)')
EOF
```

**ç»“æœ**: âœ… å…¨éƒ¨é€šè¿‡
```
Without auth: 401 (expected 401)
With correct auth: 200 (expected 200)
With wrong auth: 401 (expected 401)
```

---

### æœ¬åœ°æµ‹è¯• #6: app.py å¯¼å…¥æµ‹è¯•

```bash
$ export TTS_API_KEY="sk-test"
$ python3 -c "from app import app; print('âœ“ app.py imports successfully')"
```

**ç»“æœ**: âœ… æˆåŠŸ

---

## æ–‡ä»¶å˜æ›´æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¡Œæ•°å˜åŒ– | è¯´æ˜ |
|------|---------|---------|------|
| `api/auth.py` | ä¿®å¤ | 1 è¡Œä¿®æ”¹ | æ·»åŠ ç¯å¢ƒå˜é‡é»˜è®¤å€¼ |
| `api/index.py` | ä¿®å¤ | 3 è¡Œï¼š-1, +3 | è°ƒæ•´é™æµå™¨åˆå§‹åŒ–ä½ç½® |
| `app.py` | ä¿®å¤ | 3 è¡Œï¼š-1, +3 | åŒæ­¥ api/index.py ä¿®å¤ |
| `.env.example` | æ”¹è¿› | +15 è¡Œ | æ›´æ–°æ–‡æ¡£å’Œæ³¨é‡Š |
| `VERCEL-DEBUG-REPORT.md` | æ–°å»º | +450 è¡Œ | æ·±åº¦è°ƒè¯•æŠ¥å‘Š |
| `VERCEL-ENVIRONMENT-SETUP.md` | æ–°å»º | +360 è¡Œ | ç¯å¢ƒå˜é‡é…ç½®æŒ‡å— |
| `VERCEL-FIX-IMPLEMENTATION.md` | æ–°å»º | å½“å‰æ–‡ä»¶ | ä¿®å¤å®æ–½æŠ¥å‘Š |

**æ€»è®¡**: 3 ä¸ªæ–‡ä»¶ä¿®å¤ï¼Œ1 ä¸ªæ–‡ä»¶æ”¹è¿›ï¼Œ3 ä¸ªæ–‡æ¡£æ–°å»º

---

## å‘åå…¼å®¹æ€§

### âœ… å®Œå…¨å…¼å®¹

æ‰€æœ‰ä¿®å¤éƒ½ä¿æŒå‘åå…¼å®¹ï¼š

1. **ç¯å¢ƒå˜é‡**: ç°æœ‰çš„ `TTS_API_KEY` é…ç½®æ— éœ€æ”¹åŠ¨
2. **API æ¥å£**: æ‰€æœ‰ç«¯ç‚¹ã€å‚æ•°ã€å“åº”æ ¼å¼ä¿æŒä¸å˜
3. **è®¤è¯æœºåˆ¶**: å¤šå¯†é’¥æ”¯æŒä¿æŒä¸å˜
4. **é™æµé…ç½®**: é™æµè§„åˆ™å’Œè¡Œä¸ºä¿æŒä¸å˜
5. **éƒ¨ç½²é…ç½®**: Dockerã€docker-composeã€vercel.json æ— éœ€ä¿®æ”¹

### å‡çº§è·¯å¾„

å¦‚æœæ‚¨å·²ç»éƒ¨ç½²äº†æ—§ç‰ˆæœ¬ï¼š

1. **æ‹‰å–æœ€æ–°ä»£ç **
2. **æ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶**ï¼ˆ`.env`, `vercel.json`, `docker-compose.yml`ï¼‰
3. **é‡æ–°éƒ¨ç½²å³å¯**

---

## Vercel éƒ¨ç½²æ£€æŸ¥æ¸…å•

åœ¨ Vercel éƒ¨ç½²å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²åœ¨ Vercel ä»ªè¡¨æ¿é…ç½® `TTS_API_KEY` ç¯å¢ƒå˜é‡
- [ ] ï¼ˆå¯é€‰ï¼‰å·²é…ç½®å…¶ä»–ç¯å¢ƒå˜é‡ï¼ˆREDIS_URL, SENTRY_DSN ç­‰ï¼‰
- [ ] æ‹‰å–äº†åŒ…å«ä¿®å¤çš„æœ€æ–°ä»£ç 
- [ ] æŸ¥çœ‹äº† `VERCEL-ENVIRONMENT-SETUP.md` æ–‡æ¡£

éƒ¨ç½²åéªŒè¯ï¼š

- [ ] è®¿é—® `/health` ç«¯ç‚¹è¿”å› 200 OK
- [ ] è®¿é—® `/v1/models` éœ€è¦è®¤è¯ï¼ˆæ— è®¤è¯è¿”å› 401ï¼‰
- [ ] ä½¿ç”¨æ­£ç¡®çš„ API å¯†é’¥å¯ä»¥è®¿é—® `/v1/models`
- [ ] TTS API `/v1/audio/speech` å¯ä»¥æ­£å¸¸å·¥ä½œ

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆéƒ¨ç½²å‰ï¼‰

1. âœ… åœ¨ Vercel ä»ªè¡¨æ¿é…ç½® `TTS_API_KEY`
2. âœ… é˜…è¯» `VERCEL-ENVIRONMENT-SETUP.md`
3. âœ… å‡†å¤‡ç”Ÿäº§ç¯å¢ƒçš„ API å¯†é’¥ï¼ˆå¼ºå¯†é’¥ï¼‰

### éƒ¨ç½²å

1. âœ… æ‰§è¡Œå¥åº·æ£€æŸ¥éªŒè¯
2. âœ… æµ‹è¯•è®¤è¯åŠŸèƒ½
3. âœ… æµ‹è¯• TTS API ç«¯ç‚¹
4. âœ… ç›‘æ§æ—¥å¿—ï¼ˆç¡®è®¤æ— é”™è¯¯ï¼‰

### å¯é€‰æ”¹è¿›

1. âšª é…ç½® Redis ç”¨äºåˆ†å¸ƒå¼é™æµ
2. âšª é…ç½® Sentry ç”¨äºé”™è¯¯ç›‘æ§
3. âšª è®¾ç½®è‡ªå®šä¹‰åŸŸå
4. âšª é…ç½® CI/CD è‡ªåŠ¨éƒ¨ç½²

---

## æŠ€æœ¯å€ºåŠ¡å’Œæœªæ¥æ”¹è¿›

### å·²è§£å†³

- âœ… ç¯å¢ƒå˜é‡å¤„ç†ä¸å®‰å…¨
- âœ… åˆå§‹åŒ–é¡ºåºé”™è¯¯
- âœ… æ–‡æ¡£ä¸å®Œæ•´

### ä»éœ€æ”¹è¿›ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

1. **text_processor.py æ¸…ç†**: 
   - æ–‡ä»¶ä»å­˜åœ¨ä½†æœªä½¿ç”¨
   - å»ºè®®ï¼šåˆ é™¤ä»¥ä¿æŒä»£ç åº“æ¸…æ´
   - ä¼˜å…ˆçº§ï¼šä½ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

2. **nano_tts.py é”™è¯¯å¤„ç†**:
   - æ¨¡å‹åŠ è½½å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯å¯ä»¥æ›´æ¸…æ™°
   - å»ºè®®ï¼šæ”¹è¿›é”™è¯¯æç¤ºå’Œæ—¥å¿—
   - ä¼˜å…ˆçº§ï¼šä½ï¼ˆå½“å‰æœ‰é»˜è®¤æ¨¡å‹å…œåº•ï¼‰

3. **é™æµå™¨æ¶æ„**:
   - å½“å‰åœ¨åˆå§‹åŒ–åæ‰èƒ½åº”ç”¨é™æµè§„åˆ™
   - å»ºè®®ï¼šè€ƒè™‘è£…é¥°å™¨æ¨¡å¼é‡æ„
   - ä¼˜å…ˆçº§ï¼šä½ï¼ˆå½“å‰æ–¹æ¡ˆå¯è¡Œï¼‰

---

## æ€»ç»“

âœ… **æ‰€æœ‰è‡´å‘½é”™è¯¯å·²ä¿®å¤**  
âœ… **æœ¬åœ°éªŒè¯å…¨éƒ¨é€šè¿‡**  
âœ… **æ–‡æ¡£å®Œå–„ï¼Œéƒ¨ç½²æŒ‡å—æ¸…æ™°**  
âœ… **ä¿æŒå‘åå…¼å®¹æ€§**  
âœ… **æœ€å°æ”¹åŠ¨ï¼Œé£é™©æœ€ä½**

**é¢„è®¡ç»“æœ**: Vercel éƒ¨ç½²å°†æˆåŠŸ ğŸ‰

---

**æŠ¥å‘Šç”Ÿæˆ**: 2024-12-12  
**å·¥ç¨‹å¸ˆ**: NanoAI TTS ç»´æŠ¤å›¢é˜Ÿ  
**å®¡æ ¸çŠ¶æ€**: å·²éªŒè¯  
**ä¸‹ä¸€æ­¥**: éƒ¨ç½²åˆ° Vercel å¹¶éªŒè¯
